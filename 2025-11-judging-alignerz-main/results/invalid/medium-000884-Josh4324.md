# [000884] Stale unclaimedAmountsIn Mapping Used in Dividend Distribution
  
  ### Summary

The _setDividends() function relies on the mapping unclaimedAmountsIn[nftId] to compute the stablecoin dividends allocated to each TVS holder. However, this mapping is never refreshed inside _setDividends(), nor is _setDividends() guaranteed to be called after _setAmounts() and a full recomputation of all unclaimed amounts. As a result, stale or outdated values inside unclaimedAmountsIn are used to distribute rewards, leading to incorrect or unfair dividend allocations.

### Root Cause

https://github.com/dualguard/2025-11-alignerz/blob/main/protocol/src/contracts/A26ZDividendDistributor/A26ZDividendDistributor.sol

The function _setDividends() calculates each userâ€™s share of stablecoins as:

```sol
function _setDividends() internal {
    uint256 len = nft.getTotalMinted();
    for (uint256 i; i < len;) {
        (address owner, bool isOwned) = safeOwnerOf(i);
        if (isOwned) {
            dividendsOf[owner].amount +=
                (unclaimedAmountsIn[i] * stablecoinAmountToDistribute / totalUnclaimedAmounts);
        }
        unchecked { ++i; }
    }
}

```

However, the values in unclaimedAmountsIn are updated only inside getUnclaimedAmounts(nftId), and this function:

Is not automatically called before _setDividends(),

Is not called inside _setDividends() itself,

Is not guaranteed to have been run for all NFTs before dividends are calculated.

This means _setDividends() may operate on partial, out-of-date, or completely stale values, depending on when and how the contract owner last invoked functions that implicitly update the mapping.

This violates expected accounting assumptions and breaks the determinism of dividend calculations.



### Internal Pre-conditions

None

### External Pre-conditions

None

### Attack Path

None

### Impact

Users will receive wrong amounts of stablecoin because rewards are computed using outdated values.



### PoC

None

### Mitigation

Always Recompute Unclaimed Amounts Inside _setDividends()
  