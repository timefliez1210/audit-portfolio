# [000512] Uninitialized Memory Arrays Cause splitTVS to Always Revert - Complete DoS of Split Functionality
  
  ### Summary

The `_computeSplitArrays()` function creates an `Allocation` struct in memory but never initializes its dynamic arrays. When the code tries to write `alloc.amounts[0] = value`, it attempts to write to a zero-length array, causing an immediate revert. This makes `splitTVS()` completely unusable for any NFT with vesting flows.


### Root Cause


In `AlignerzVesting.sol` the `_computeSplitArrays()` function  creates an `Allocation` struct in memory but never initializes its dynamic arrays. When the code tries to write `alloc.amounts[0] = value`, it attempts to write to a zero-length array, causing an immediate revert. 
```solidity
function _computeSplitArrays(
    Allocation storage allocation,
    uint256 percentage,
    uint256 nbOfFlows
) internal view returns (Allocation memory alloc) {
    
@>  //  alloc is declared but arrays are NOT initialized
    // alloc.amounts has length 0
    // alloc.vestingPeriods has length 0
    // etc.
    
    uint256[] memory baseAmounts = allocation.amounts;
    // ... copy other arrays ...
    
    alloc.assignedPoolId = allocation.assignedPoolId;
    alloc.token = allocation.token;
    
    for (uint256 j; j < nbOfFlows;) {
@>      alloc.amounts[j] = (baseAmounts[j] * percentage) / BASIS_POINT;  //  REVERT!
        // Writing to alloc.amounts[0] when length = 0 → OUT OF BOUNDS
        alloc.vestingPeriods[j] = baseVestings[j];
        alloc.vestingStartTimes[j] = baseVestingStartTimes[j];
        alloc.claimedSeconds[j] = baseClaimed[j];
        alloc.claimedFlows[j] = baseClaimedFlows[j];
        unchecked { ++j; }
    }
}
```
Code Snippet-
https://github.com/dualguard/2025-11-alignerz/blob/f7eeed88d91356484c02af6f38b71f27b790828c/protocol/src/contracts/vesting/AlignerzVesting.sol#L1113-L1141


### Internal Pre-conditions

1. User has NFT with any vesting flows (nbOfFlows > 0).
2. User calls `splitTVS()` with valid parameters.
3. `_computeSplitArrays()` is called with nbOfFlows > 0.


### External Pre-conditions

1. NFT owner wants to split their vesting position.
2. Calls `splitTVS()` with split percentages.


### Attack Path


1. User calls: `splitTVS(projectId, [50, 50], nftId)`
    ↓
2. `splitTVS()` gets: nbOfFlows = allocation.amounts.length = 2
    ↓
3. Calls: `_computeSplitArrays(allocation, 50, 2)`
    ↓
4. `_computeSplitArrays()` creates: Allocation memory alloc
    ↓
5. Memory state:
  alloc.amounts.length = 0  (not initialized!)
  alloc.vestingPeriods.length = 0
  alloc.vestingStartTimes.length = 0
    ↓
6. Loop: for j = 0; j < 2; j++
    ↓
7. First iteration (j=0):
  alloc.amounts[0] = baseAmounts[0] * 50 / 10000
    ↓
8. REVERT: Index out of bounds
   (Trying to write to index 0 of zero-length array)
    ↓
9. Transaction FAILS


### Impact

`splitTVS()` always reverts for any NFT with flows. Users cannot split their vesting positions. Create DoS scenario.

### PoC

N/A

### Mitigation

N/A
  