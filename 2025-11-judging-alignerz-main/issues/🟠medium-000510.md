# [000510] Owner Can Drain Refund Funds Before Users Claim, Permanently Locking Rejected Bidders' Money
  
  ### Summary

The owner can call `withdrawPostDeadlineProfit()` to withdraw ALL stablecoins (`totalStablecoinBalance`) immediately after the deadline(atleast one refund user not claim his refund amount), even if users haven't claimed their refunds yet. When users later try to claim refunds via `claimRefund()`, the contract has zero balance, causing transfers to fail and permanently locking their funds.

### Root Cause

See Summary & ...

In `AlignerzVesting.sol` the  `withdrawPostDeadlineProfit()` function not deducting refund amount from `biddingProject.totalStablecoinBalance` leads to Refund user not able to claim his refund amount(assuming atleast one refund user not claim his refund amount when owner calling this function).
 **No tracking of pending refunds:**
```solidity
function withdrawPostDeadlineProfit(uint256 projectId) external onlyOwner {
    ...
@>  uint256 amount = biddingProject.totalStablecoinBalance; //  Withdraws EVERYTHING
    biddingProject.stablecoin.safeTransfer(treasury, amount);
    biddingProject.totalStablecoinBalance = 0;
}
```
Buth when refund user going to withdraw refund amount deduct from `biddingProject.totalStablecoinBalance`. So if owner call `withdrawPostDeadlineProfit()` function  when atleast one refund user is there, who did not claim his refund amount. On that scenario after calling `withdrawPostDeadlineProfit()` function by owner, if that user came to claim his refund amount, on that case User not able to withdraw his refund because `biddingProject.totalStablecoinBalance -= amount;` will always revert.
 **Refunds deduct from the same balance:**
```solidity
function claimRefund(...) external {
    ...
@>  biddingProject.totalStablecoinBalance -= amount; //  Tries to deduct from 0
    biddingProject.stablecoin.safeTransfer(msg.sender, amount); //  Reverts (no tokens)
}
```
Same things for `withdrawAllPostDeadlineProfits()` and `withdrawPostDeadlineProfits(uint256[] calldata projectIds)` also.

Code snippet- 
https://github.com/dualguard/2025-11-alignerz/blob/f7eeed88d91356484c02af6f38b71f27b790828c/protocol/src/contracts/vesting/AlignerzVesting.sol#L914-L922


### Internal Pre-conditions


1. Project has rejected bids so Refund merkle root is set for claim refund amount for this project . 
2. Claim deadline passes means `block.timestamp > claimDeadline` for this project.  
3. When Owner calls `withdrawPostDeadlineProfit()` function then there is atleast one user, who is eligible for refund but not claim his refund amount for this project. 

### External Pre-conditions

1. Eligible user try claim his refund amount by calling `claimRefund()` after execution of owners `withdrawPostDeadlineProfit()` function for this project.

### Attack Path

Assuming all fee is 0 on that example.

Initial State:
├─ totalStablecoinBalance = 10,000 USDC
├─ Accepted bids = 7,000 USDC (already allocated to vesting)
├─ Rejected bids (refunds owed) = 3,000 USDC
│   ├─ Alice: 1,000 USDC
│   ├─ Bob: 1,200 USDC
│   └─ Carol: 800 USDC
└─ Refund merkle root set for 3,000 USDC

Timeline:
───────────────────────────────────────────────────────
Day 1: Bidding closes, allocations finalized
Day 10: claimDeadline = block.timestamp
Day 11:  Owner calls `withdrawPostDeadlineProfit()`

Step 1: Owner Withdraws
─────────────────────────
`withdrawPostDeadlineProfit(projectId)`:
├─ amount = totalStablecoinBalance = 10,000 USDC 
├─ Transfer 10,000 USDC → treasury 
└─ totalStablecoinBalance = 0

Contract Balance: 0 USDC
Refunds Owed: 3,000 USDC (still owed to Alice, Bob, Carol)

Day 12: Alice tries to claim refund
─────────────────────────
claimRefund(projectId, 1000, merkleProof):
├─ Merkle proof valid 
├─ claimedRefund[leaf] = false 
├─ totalStablecoinBalance -= 1000 → 0 - 1000 = underflow 
└─ OR if no underflow check:
    └─ safeTransfer(Alice, 1000) ---> REVERTS
        Reason: Contract has 0 USDC, trying to send 1000


### Impact

Users lose their rejected bid refunds amount permanently when atlest one or more user did not claim his refund amount before admin calling `withdrawPostDeadlineProfit()` for this project Id.

If we consider that situation where, owner will wait for all refund users, until claims their refunds amounts. On that case malicious User can force owner to wait infinite time. Leads to owner not able to utilize this funds.


### PoC

N/A

### Mitigation

N/A
  