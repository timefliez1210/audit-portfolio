# [000672] Missing initialization of `newAmounts` leads to out-of-bounds panic and DoS in `calculateFeeAndNewAmountForOneTVS()`
  
  ### Summary

The missing initialization of the newAmounts array in `calculateFeeAndNewAmountForOneTVS()` causes an out-of-bounds write, which results in a deterministic panic during execution.
This leads to a full Denial of Service for any user or contract attempting to call this function, as the caller will always revert before obtaining a result.
Because both `mergeTVS()` and `splitTVS()` internally call `calculateFeeAndNewAmountForOneTVS()`, this bug makes both higher-level TVS management operations revert systematically, breaking core vesting functionality.

### Root Cause

https://github.com/dualguard/2025-11-alignerz/blob/main/protocol/src/contracts/vesting/feesManager/FeesManager.sol#L169
In FeesManager.sol, inside the function `calculateFeeAndNewAmountForOneTVS()`, the return array `newAmounts` is declared but never initialized:
``` solidity
uint256[] memory newAmounts; // uninitialized
newAmounts[i] = amounts[i] - feeAmount; // always out-of-bounds
```
Because `newAmounts` has no allocated memory, any write to `newAmounts[i]` triggers a panic(0x32) (“array out-of-bounds”).
Thus, the function will always revert for any input, making it unusable.

### Internal Pre-conditions

_No response_

### External Pre-conditions

_No response_

### Attack Path

1. A user or contract must call either `mergeTVS()` or `splitTVS()`.
2. These functions internally call `calculateFeeAndNewAmountForOneTVS()`.
3. Inside that function, `newAmounts` is uninitialized, making every write `newAmounts[i]` trigger a panic.
4. As a result, any call to merge or split a TVS reverts, regardless of inputs.

### Impact

Because `mergeTVS()` and `splitTVS()` depend on `calculateFeeAndNewAmountForOneTVS()`, the entire TVS management system becomes unusable:
- Users cannot merge TVSs.
- Users cannot split TVSs.
- Any protocol logic relying on these functions is broken.

### Severity

High

### PoC

Add the following test in AlignerzVestingProtocolTest.t.sol and run the following command :
```solidity 
forge test --match-test test1calculateFeeAndNewAmountForOneTVS
```
```solidity
function test1calculateFeeAndNewAmountForOneTVS() public {
        uint feeRate = 300; //3%
        uint256 length = 5;

        uint256[] memory amounts = new uint256[](length);

        amounts[0] = 1000;
        amounts[1] = 2000;
        amounts[2] = 3000;
        amounts[3] = 4000;
        amounts[4] = 5000;
        vm.expectRevert(stdError.indexOOBError); //array out-of-bounds error
        vesting.calculateFeeAndNewAmountForOneTVS(feeRate, amounts, length);
    }
```

### Mitigation

Initialize `newAmounts` in `calculateFeeAndNewAmountForOneTVS()`:
```solidity
newAmounts = new uint256[](length);
```
  