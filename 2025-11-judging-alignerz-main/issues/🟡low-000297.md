# [000297] Improper array index management
  
  
**Summary:** Array index logic contains a bug that can corrupt project data and lock funds.

**Vulnerability Details:** The element removal logic isn't properly removing the element it should remove which will lead to data corruption in the array. The line `rewardProject.kolTVSIndexOf[kol] = arrayLength - 1;` should be deleted not reassigned, the line makes the mapping point to the old last index, even though the address is removed.
```javascript
 function _claimRewardTVS(uint256 rewardProjectId, address kol) internal {
        RewardProject storage rewardProject = rewardProjects[rewardProjectId];
        uint256 amount = rewardProject.kolTVSRewards[kol];
        // the rest of the code...

        uint256 index = rewardProject.kolTVSIndexOf[kol];
        uint256 arrayLength = rewardProject.kolTVSAddresses.length;
        //@audit
        @-> rewardProject.kolTVSIndexOf[kol] = arrayLength - 1; 
        address lastIndexAddress = rewardProject.kolTVSAddresses[arrayLength - 1];
        @-> rewardProject.kolTVSIndexOf[lastIndexAddress] = index; 
        rewardProject.kolTVSAddresses[index] = rewardProject.kolTVSAddresses[arrayLength - 1];
        rewardProject.kolTVSAddresses.pop();
       
        emit RewardTVSClaimed(rewardProjectId, kol, nftId, amount, vestingPeriod);
    }
```

**Impact:**
1. Corrupted index mappings causing incorrect KOL lookups
2. Some KOLs becoming unclaimable
3. Array out-of-bounds access potential

**Tool Used:** Manuel review

**Affected line of code:**https://github.com/dualguard/2025-11-alignerz/blob/main/protocol/src/contracts/vesting/AlignerzVesting.sol#L601

**Therortical POC:**

**// Initial state:**

kolTVSAddresses = [A, B, C]

kolTVSIndexOf = {A:0, B:1, C:2}

Remove KOL B (index 1):

index = 1

arrayLength = 3

**where the bug is :**
kolTVSIndexOf[B] = 2 // Now B points to index 2 (invalid)

lastIndexAddress = C (index 2)

kolTVSIndexOf[C] = 1 // Now C points to index 1 

kolTVSAddresses[1] = C 

kolTVSAddresses.pop() // Removes last element â†’ [A, C] 

Result:

kolTVSAddresses = [A, C]

kolTVSIndexOf = {A:0, B:2, C:1}


// PROBLEMS:

 - B still in mapping pointing to invalid index 2

- If we try to claim B again, will access out-of-bounds index

- Array inconsistency

**Recommended Mitigation:** 
instead use `delete rewardProject.kolTVSIndexOf[kol];` without this, the mapping will still think the deleted KOL exists.

  