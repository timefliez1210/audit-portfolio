# [000644] Withdrawn Stuck Tokens May Affect Pool Economy
  
  ### Summary

The owner can withdraw tokens that are part of active vesting allocations, causing users to be unable to claim their full entitlements.

### Root Cause

In `AlignerzVesting.sol:withdrawStuckTokens()` ([lines ~368–377](https://github.com/dualguard/2025-11-alignerz/blob/f7eeed88d91356484c02af6f38b71f27b790828c/protocol/src/contracts/vesting/AlignerzVesting.sol#L374C5-L381C6)), there is no check to ensure withdrawn amount doesn't exceed free (unallocated) balance or if claimPeriod has been exceeded.

### Internal Pre-conditions

1. Active vesting allocations must exist with tokens in the contract  

2. Owner calls `withdrawStuckTokens()` with amount >= allocated balance

### External Pre-conditions

_No response_

### Attack Path

1. Contract holds 1000 USDC with 500 allocated to active vestings```solidity

2. Owner calls `withdrawStuckTokens(USDC, 600)` (exceeds free balance of 500)

3. 600 USDC withdrawn from contractfunction distributeRemainingRewardTVS(uint256 rewardProjectId) uint256 perFee = calculateFeeAmount(feeRate, amounts[i]);

4. Users try to claim remaining allocations → insufficient balance

### Impact

The users suffer up to 100% loss of their allocated tokens as the owner can drain allocated funds. The protocol loses user trust.

### PoC

```solidity
function test_PoC_withdraw_stuck_tokens_affects_claims() public {
        vm.prank(projectCreator);
        vesting.launchRewardProject(address(token), address(usdt), block.timestamp, 1_000);

        address[] memory kols = new address[](1);
        kols[0] = address(this);
        uint256[] memory amounts = new uint256[](1);
        amounts[0] = 20 ether;

        vm.prank(projectCreator);
        vesting.setTVSAllocation(0, 20 ether, 30 days, kols, amounts);

        uint256 before = nft.getTotalMinted();
        vm.prank(address(this));
        vesting.claimRewardTVS(0);
        uint256 nftId = before;

        // Owner withdraws the tokens from the contract
        vm.prank(projectCreator);
        vesting.withdrawStuckTokens(address(token), 20 ether);

        // Warp to allow claims
        vm.warp(block.timestamp + 1 days);

        vm.prank(address(this));
        vm.expectRevert();
        vesting.claimTokens(0, nftId);
    }
```

### Mitigation

```solidity

mapping(address => uint256) allocatedPerToken;

function withdrawStuckTokens(address tokenAddress, uint256 amount) external onlyOwner {

    IERC20 token = IERC20(tokenAddress);

    uint256 free = token.balanceOf(address(this)) - allocatedPerToken[tokenAddress];

    require(amount <= free, "Cannot_Withdraw_Allocated_Tokens");
    require(block.timestamp > deadline, Deadline_Has_Not_Passed());
    token.safeTransfer(msg.sender, amount);

}

```
  