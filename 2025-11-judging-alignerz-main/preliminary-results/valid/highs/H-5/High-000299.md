# [000299] Incorrect calculation in `calculateFeeAndNewAmountForOneTVS` function.
  
  
**Summary:**  The function ` calculateFeeAndNewAmountForOneTVS` incorrectly uses cumulative total fees instead of individual fees when calculating new amounts, causing progressively worse miscalculations.

**Root Cause:** The `feeAmount` variable continues to accumulate inside the ` calculateFeeAndNewAmountForOneTVS` function which is wrong, it should calculate for individual fee instead of accumulating fee in the loop of the array.

**Vulnerability Details:** The function `calculateFeeAndNewAmountForOneTVS` uses the total fee which `feeAmount` accumulates across the loop, but the function is subtracting the total cummulative fee from each indidividual element and this causes incorrect result
```javascript
//Calculate total fees across multiple amounts
    
    function calculateFeeAndNewAmountForOneTVS(uint256 feeRate, uint256[] memory amounts, uint256 length) public pure returns (uint256 feeAmount, uint256[] memory newAmounts) {
        for (uint256 i; i < length;) {
            //uses cummulative fee instead of individual fee.
            feeAmount += calculateFeeAmount(feeRate, amounts[i]);//@audit-issue
            newAmounts[i] = amounts[i] - feeAmount;
        }
    }
```
Example: amounts = [100, 200, 300], feeRate = 10% (0.1)

Current behavior:
1. i=0: feeAmount = 10, newAmounts[0] = 100 - 10 = 90(this is correct)
2. i=1: feeAmount = 10 + 20 = 30, newAmounts[1] = 200 - 30 = 170 //this is wrong (should be 180)
3. i=2: feeAmount = 30 + 30 = 60, newAmounts[2] = 300 - 60 = 240 //this is wrong (should be 270)


**Impact:**
1. Progressive financial miscalculations where later amounts are overcharged
2. Users receive incorrect amounts in batch operations
3. First item correct, second overcharged by fee0, third overcharged by (fee0 + fee1), etc.
4. Significant financial losses in multi-item batch operations

**Tool Used:** Manual review

**POC:**

Affected Line of code:https://github.com/dualguard/2025-11-alignerz/blob/main/protocol/src/contracts/vesting/feesManager/FeesManager.sol#L169

**Recommended Mitigation:** the function should be rewritten as this:
```javascript
function calculateFeeAndNewAmountForOneTVS(uint256 feeRate, uint256[] memory amounts, uint256 length) 
    public pure returns (uint256 totalFeeAmount, uint256[] memory newAmounts) 
{
    totalFeeAmount = 0;
    for (uint256 i; i < length;) {
        uint256 individualFee = calculateFeeAmount(feeRate, amounts[i]);
        totalFeeAmount += individualFee;
        newAmounts[i] = amounts[i] - individualFee; // Use individual fee only
}
```
  