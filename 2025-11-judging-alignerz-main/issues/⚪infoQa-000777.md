# [000777] Reentrancy via NFT Mint During Allocation Split
  
  ### Summary

A lack of reentrancy protection will cause a state inconsistency vulnerability for the vesting contract as the NFT owner will call `splitTVS` which performs state updates after external calls to mint NFTs.

### Root Cause

In `AlignerzVesting.sol:splitTVS` the function does not follow the Checks-Effects-Interactions (CEI) pattern or implement reentrancy guards. The function updates storage allocations after calling `nftContract.mint(msg.sender)`, which triggers `onERC721Received` callbacks. Since the NFT contract uses `safeMint`, a malicious recipient contract can reenter `splitTVS` and manipulate the allocation state before it is fully committed.

[reentrancy line](https://github.com/dualguard/2025-11-alignerz/blob/main/protocol/src/contracts/vesting/AlignerzVesting.sol#L1086)

[storage manipulation after reentrancy](https://github.com/dualguard/2025-11-alignerz/blob/main/protocol/src/contracts/vesting/AlignerzVesting.sol#L1088-L1092)

### Internal Pre-conditions

_No response_

### External Pre-conditions

_No response_

### Attack Path

1. Attacker (NFT owner) calls `splitTVS` with a crafted set of percentages
2. The function transfers fees to treasury via `safeTransfer`
3. During the loop, `nftContract.mint(msg.sender)` is called, invoking `onERC721Received` on the attacker's contract
4. The attacker's contract reenters `splitTVS` using the same `splitNftId`, before the original allocation state has been fully written to storage
5. The reentered call reads a partially updated `allocation.amounts` array and performs computations on stale data
6. Control returns to the original call, which completes and writes inconsistent allocation state to storage
7. Attacker now controls multiple allocations with miscalculated vesting amounts and periods


### Impact

The vesting contract suffers state corruption that may result in incorrect token distribution. Depending on the reentry pattern, legitimate users may suffer loss of vesting amounts or early/late token unlocking. The attacker can potentially gain access to additional vesting allocations or manipulate claim timing without suffering direct loss.

### PoC

_No response_

### Mitigation

-  Implement the Checks-Effects-Interactions pattern : Update all allocation state before calling `nftContract.mint()`. 

- Add reentrancy protection: Use OpenZeppelin's `ReentrancyGuard` and apply the `nonReentrant` modifier to every function that mints NFTs.

  