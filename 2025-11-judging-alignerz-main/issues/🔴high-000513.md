# [000513] Infinite Loop DoS - Missing Loop Increment Causes Out-of-Gas and Contract Unusability
  
  ### Summary

The `calculateFeeAndNewAmountForOneTVS` function has a critical bug: the for-loop never increments the counter `i`, causing an infinite loop that exhausts gas and reverts. This makes the function completely unusable and breaks all dependent functionality (mergeTVS, splitTVS).


### Root Cause


In `FeesManager.sol` the `calculateFeeAndNewAmountForOneTVS()` function not incrementing  i value after completing iteration.

```solidity
function calculateFeeAndNewAmountForOneTVS(
    uint256 feeRate, 
    uint256[] memory amounts, 
    uint256 length
) public pure returns (uint256 feeAmount, uint256[] memory newAmounts) {
    for (uint256 i; i < length;) {  // ← Loop starts with i=0
        feeAmount += calculateFeeAmount(feeRate, amounts[i]);
        newAmounts[i] = amounts[i] - feeAmount;
@>      // ← NO INCREMENT! i stays 0 forever
    }
}
```
Code Snippet-
https://github.com/dualguard/2025-11-alignerz/blob/f7eeed88d91356484c02af6f38b71f27b790828c/protocol/src/contracts/vesting/feesManager/FeesManager.sol#L169-L172


### Internal Pre-conditions

N/A

### External Pre-conditions

1. User calls `mergeTVS()` or `splitTVS()` with `mergedTVS.amounts.length/splitTVS.amounts.length > 0`.


### Attack Path



1. User calls `mergeTVS()` 
    
2. `calculateFeeAndNewAmountForOneTVS(feeRate, [100, 200], 2)`
    
3. Loop starts:
    i = 0, length = 2
    ↓
    i < 2? YES → Execute loop body
    ↓
    feeAmount += calculateFeeAmount(feeRate, amounts[0])
    newAmounts[0] = amounts[0] - feeAmount
    ↓
    i still = 0 (NO INCREMENT!)
    ↓
    i < 2? YES → Execute loop body AGAIN
    ↓
    feeAmount += calculateFeeAmount(feeRate, amounts[0])  ← Same calculation
    newAmounts[0] = amounts[0] - feeAmount  ← Overwrite same slot
    ↓
    i still = 0
    ↓
    ... INFINITE LOOP ...
    ↓
    Gas exhausted → REVERT 



### Impact

Permanent Dos of `mergeTVS()` or `splitTVS()` function. Users cannot merge/split their positions.


### PoC

N/A

### Mitigation

N/A
  