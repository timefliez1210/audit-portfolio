# [000386] Unfair fee assessment on splitTVS and mergeTVS charges users for already claimed tokens
  
  ### Summary

Calculating fees based on the original allocation amount rather than the remaining unclaimed balance will cause an excessive loss of funds for users who have partially claimed their tokens as the protocol will deduct fees corresponding to tokens that have already been withdrawn from the contract.

### Root Cause

In `AlignerzVesting.sol`, the `claimTokens `function updates the `claimedSeconds `for a flow but does not decrement the `amounts `array in the `Allocation `struct. The `amounts `array persistently reflects the initial total allocation.

When a user subsequently calls `splitTVS `or `mergeTVS`, the contract invokes `FeesManager.calculateFeeAndNewAmountForOneTVS`. This function uses the static `amounts `array to calculate the protocol fee.

- In `_split`: `uint256 fee = calculateFeeAmount(splitFeeRate, allocation.amounts[i]);`
- In `_merge`: `uint256 fee = calculateFeeAmount(mergeFeeRate, TVSToMerge.amounts[j]);`

This logic fails to account for the fact that a portion of `amounts[i]` may have already been claimed by the user via `claimTokens`. As a result, the fee is applied to the historical principal rather than the current active principal.

### Internal Pre-conditions

_No response_

### External Pre-conditions

_No response_

### Attack Path

1. User creates a vesting schedule for 10,000 tokens over 12 months.

2. User waits 6 months and calls claimTokens.
       -User receives 5,000 tokens.
       -The vesting contract now holds only 5,000 tokens for this NFT.

3. User decides to split the NFT (e.g., to sell half of the remaining position). They call splitTVS.

4. The protocol calculates the split fee (assume 2% rate):
        -Calculation: 10,000 (Original Amount) * 2% = 200 tokens.

5. The protocol deducts 200 tokens from the NFT's remaining allocation.

6. The Issue: The user effectively paid 200 tokens on a remaining balance of 5,000. This is an effective fee rate of 4%, double the advertised rate. The user paid fees on the 5,000 tokens they already safely ruined in their wallet.

### Impact

The users suffer a loss of funds proportional to the amount they have already claimed.

1. In the example above, the user overpaid by 100 tokens.

2. Critical Severity Scenario: Consider a user who has claimed 98% of their tokens (9,800 claimed, 200 remaining). If they attempt to split the TVS to manage the final 200 tokens:
        -  Fee calculation: 10,000 * 2% = 200.
        -  Deduction: 200 tokens.
        -  Result: The fee consumes 100% of the remaining balance. The user loses their entire residual position due to       the fee logic being applied to the historical total.

### PoC

_No response_

### Mitigation

- The fee calculation logic in _split and _merge must account for the proportion of the TVS that has already been claimed.

- Update the logic to calculate fees based on the Unclaimed Amount rather than the total amount.
  