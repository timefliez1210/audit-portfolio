# [000649] Issues in `calculateFeeAndNewAmountForOneTVS()` - Broken Fee Calculation
  
  ### Summary

The fee calculation helper will produce incorrect fee amounts, breaking merge/split operations and corrupting vesting allocations.


### Root Cause

In calculateFeeAndNewAmountForOneTVS() (https://github.com/dualguard/2025-11-alignerz/blob/f7eeed88d91356484c02af6f38b71f27b790828c/protocol/src/contracts/vesting/feesManager/FeesManager.sol#L169C5-L175C1)

Fee subtraction uses cumulative total instead of per-item fee 

### Internal Pre-conditions

1. Caller needs to invoke a merge or split operation that uses this helper

### External Pre-conditions

_No response_

### Attack Path

1. User calls `mergeTVS()` or `splitTVS()`shortKol[0] = kol1;- If `kol.length == kolTVSAddresses.length`: Function works accidentally, but contract state is not properly consumed

2. Internal code calls `calculateFeeAndNewAmountForOneTVS()` to compute fees

3. Function returns `newAmounts` that cumulative fees had been deducted.

### Impact

The users loses more than they should for fees when the merge/split.

### PoC

uint256 feeRate = 500; // 5%
uint256[] memory amount = new uint256[](2);
amount[0] = 1000 ether;
amount[1] = 500 ether;

let's take this scenario when when try to merge or split
The math used calculates the amount[0] fee as 50 ether, then fee for amount[1] is calculated as 50 ether + it's on 5% which is 25 making the fee for amount[1] 75 ether so new amounts will be returned as 950, 425, respectively.

### Mitigation

```solidity
function calculateFeeAndNewAmountForOneTVS(

    uint256 feeRate, 

    uint256[] memory amounts, function distributeRewardTVS(uint256 rewardProjectId, address[] calldata kol) ```solidity

    uint256 length

) public pure returns (uint256 feeAmount, uint256[] memory newAmounts) {    

    newAmounts = new uint256[](length);    

    for (uint256 i = 0; i < length;) {

        uint256 perFee = calculateFeeAmount(feeRate, amounts[i]);  

        newAmounts[i] = amounts[i] - perFee;

        feeAmount += perFee;    uint256 len = kol.length;  

        unchecked { ++i; }

    }   

    return (feeAmount, newAmounts);

}

```
  