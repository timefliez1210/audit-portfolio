# [000514] Uninitialized Memory Array - Writing to Non-Existent Array Causes Undefined Behavior
  
  ### Summary

The `calculateFeeAndNewAmountForOneTVS()` function declares `newAmounts` as a memory array but never allocates memory for it. The code then attempts to write to `newAmounts[i]`, which writes to undefined/non-existent memory. This causes unpredictable behavior including potential reverts, memory corruption, or invalid return values.


### Root Cause


In `FeesManager.sol` the `calculateFeeAndNewAmountForOneTVS()` function declares `newAmounts` as a memory array but never allocates memory for it.

```solidity
function calculateFeeAndNewAmountForOneTVS(
    uint256 feeRate, 
    uint256[] memory amounts, 
    uint256 length
) public pure returns (uint256 feeAmount, uint256[] memory newAmounts) {
    //  newAmounts is DECLARED but NOT ALLOCATED
    // It's just a zero-length pointer to nowhere
    
    for (uint256 i; i < length;) {
        feeAmount += calculateFeeAmount(feeRate, amounts[i]);
        newAmounts[i] = amounts[i] - feeAmount;  //  WRITING TO NON-EXISTENT MEMORY!
    }
}
```
Code snippet-
https://github.com/dualguard/2025-11-alignerz/blob/f7eeed88d91356484c02af6f38b71f27b790828c/protocol/src/contracts/vesting/feesManager/FeesManager.sol#L169-L172


### Internal Pre-conditions

1. Function called with any valid parameters.
2. `length > 0` (triggers write to non-existent array).


### External Pre-conditions

1. User calls `mergeTVS()` or `splitTVS()`.

### Attack Path


1. User calls: `mergeTVS()`
    
2. `calculateFeeAndNewAmountForOneTVS(100, [100, 200], 2)`
    
3. Memory state:
  - amounts[] = allocated, has data [100, 200]
  - newAmounts = NOT ALLOCATED, zero-length pointer
    
4. Attempt: newAmounts[0] = 99
    
 5. `UNDEFINED BEHAVIOR:`
  - May revert with "Index out of bounds"
  - May corrupt adjacent memory
  - May write to random memory location
  - May return garbage data
    
6. `UNPREDICTABLE FAILURE`


### Impact

This issue leads to Data Corruption. Complete DoS of `mergeTVS()` and `splitTVS()`. Split/Merge fee calculations broken.



### PoC

N/A

### Mitigation

N/A
  